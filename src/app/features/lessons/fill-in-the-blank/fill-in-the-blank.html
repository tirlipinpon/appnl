<div class="fill-in-blank-container">
  <div *ngIf="isLoading" class="loading">GÃ©nÃ©ration de la premiÃ¨re phrase...</div>
  
  <div *ngIf="isLoadingNext" class="loading-next">Chargement de la phrase suivante...</div>

  <div *ngIf="!isLoading && currentSentence" class="fill-in-blank-content">
    <div class="question-section">
      <div class="sentence-text-wrapper">
        <div class="audio-buttons-container">
          <button 
            class="help-btn" 
            (click)="requestWordHelp()" 
            *ngIf="shouldShowHelpButton() && direction === 'dutch_to_french'"
            [disabled]="isLoadingHelp"
            title="Obtenir de l'aide pour comprendre ce mot"
          >
            ğŸ’¡ Aide
          </button>
          <button 
            class="audio-btn" 
            (click)="playAudio()" 
            *ngIf="audioService.isSupported() && currentSentence"
          >
            ğŸ”Š
          </button>
          <button 
            class="audio-btn audio-btn-french" 
            (click)="playTranslationAudio()" 
            *ngIf="audioService.isSupported() && currentSentence?.translation && direction === 'dutch_to_french'"
            title="Ã‰couter la traduction en franÃ§ais"
          >
            ğŸ‡«ğŸ‡·
          </button>
        </div>
        <div 
          class="sentence-text"
          appTextSelection
          [textSelectionEnabled]="!showResult"
          [translationDirection]="direction === 'dutch_to_french' ? 'fr' : 'nl'"
          [sourceLanguage]="direction === 'dutch_to_french' ? 'nl' : 'fr'"
        >{{ getSentenceWithBlank() }}</div>
      </div>
      <div *ngIf="showResult && isCorrect && currentSentence?.translation && direction === 'dutch_to_french'" class="translation-section">
        <div class="translation-label">Traduction :</div>
        <div class="translation-text">{{ getCompleteTranslation() }}</div>
      </div>
      <div *ngIf="direction === 'french_to_dutch'" class="help-hint">
        <button 
          class="help-btn" 
          (click)="requestWordHelp()" 
          *ngIf="shouldShowHelpButton()"
          [disabled]="isLoadingHelp"
          title="Obtenir de l'aide pour comprendre ce mot"
        >
          ğŸ’¡ Aide
        </button>
        <span class="help-label">Aide :</span>
        <span class="help-word">{{ getCurrentWord()?.dutch_text }}</span>
      </div>
    </div>

    <div class="input-section">
      <div class="letter-input-container" *ngIf="letterInputs.length > 0">
        <div 
          *ngFor="let letter of letterInputs; let i = index" 
          class="letter-wrapper"
        >
          <input
            #letterInput
            type="text"
            class="letter-input"
            [class.correct]="getLetterStatus(i) === 'correct'"
            [class.incorrect]="getLetterStatus(i) === 'incorrect'"
            [attr.data-letter-index]="i"
            [value]="letterInputs[i]"
            [disabled]="showResult || !canEditInput(i)"
            maxlength="1"
            (input)="onLetterInput(i, $event)"
            (keydown)="onKeyDown(i, $event)"
            (focus)="onInputFocus(i, $event)"
            [autofocus]="i === 0"
          />
          <div 
            class="letter-bar"
            [class.correct]="getLetterStatus(i) === 'correct'"
            [class.incorrect]="getLetterStatus(i) === 'incorrect'"
          ></div>
        </div>
      </div>
    </div>

    <div class="navigation-buttons">
      <button class="btn-nav" (click)="previousQuestion()" [disabled]="currentIndex === 0 || isLoadingNext">
        â† PrÃ©cÃ©dent
      </button>
      <button class="btn-primary" (click)="nextQuestion()" [disabled]="isLoadingNext" *ngIf="currentIndex < words.length - 1 && !showResult">
        <span *ngIf="!isLoadingNext">Suivant â†’</span>
        <span *ngIf="isLoadingNext">Chargement...</span>
      </button>
    </div>

    <div class="action-buttons">
      <button 
        class="btn-skip-game" 
        (click)="nextGameRequested.emit()"
        *ngIf="!showResult"
      >
        â­ï¸ Passer au jeu suivant
      </button>
    </div>

    <div *ngIf="showResult" class="result-section">
      <div class="score">
        Score : {{ score.correct }} / {{ score.total }}
      </div>

      <button 
        class="btn-primary" 
        (click)="nextQuestion()"
        [disabled]="isLoadingNext"
        *ngIf="currentIndex < words.length - 1"
      >
        <span *ngIf="!isLoadingNext">Question suivante â†’</span>
        <span *ngIf="isLoadingNext">Chargement...</span>
      </button>
      <div *ngIf="currentIndex === words.length - 1" class="completion-actions">
        <button 
          class="btn-primary" 
          (click)="completed.emit(score)"
        >
          Terminer l'exercice
        </button>
      </div>
    </div>
  </div>

  <div class="progress-bar" *ngIf="!isLoading && currentSentence">
    <div class="progress-fill" [style.width.%]="((currentIndex + 1) / words.length) * 100"></div>
    <span class="progress-text">{{ currentIndex + 1 }} / {{ words.length }}</span>
  </div>

  <!-- Modal d'explication -->
  <div class="help-modal-overlay" *ngIf="showHelpExplanation" (click)="closeHelpExplanation()">
    <div class="help-modal" (click)="$event.stopPropagation()">
      <div class="help-modal-header">
        <h3>Explication du mot : {{ getCurrentWord()?.dutch_text }}</h3>
        <button class="close-btn" (click)="closeHelpExplanation()">Ã—</button>
      </div>
      <div class="help-modal-content">
        <div *ngIf="isLoadingHelp" class="loading-help">
          <div class="spinner"></div>
          <p>Chargement de l'explication...</p>
        </div>
        <div *ngIf="helpError" class="error-help">
          <p>{{ helpError }}</p>
        </div>
        <div *ngIf="!isLoadingHelp && !helpError && helpExplanation" class="explanation-text">
          <p [innerHTML]="formatExplanation(helpExplanation)"></p>
        </div>
      </div>
    </div>
  </div>
</div>

