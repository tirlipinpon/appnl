<div class="word-management-container">
  <div class="header">
    <div class="header-title-section">
      <h1>Gestion des mots</h1>
      <div class="user-email" *ngIf="authService.getCurrentUser()">
        <span class="email-label">Utilisateur :</span>
        <span class="email-value">{{ authService.getCurrentUser()?.email }}</span>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn-secondary" routerLink="/admin/lessons">G√©rer les le√ßons</button>
      <button class="btn-secondary" routerLink="/dashboard">Retour au tableau de bord</button>
    </div>
  </div>

  <div *ngIf="isLoading" class="loading">Chargement...</div>

  <div *ngIf="!isLoading">
    <!-- Formulaire d'ajout/√©dition -->
    <div class="form-section">
      <h2>{{ editingWord ? 'Modifier le mot' : 'Ajouter un nouveau mot' }}</h2>
      
      <form [formGroup]="wordForm" (ngSubmit)="onSubmit()" class="word-form">
        <div class="form-group">
          <label for="french_text">Fran√ßais</label>
          <input
            id="french_text"
            type="text"
            formControlName="french_text"
            placeholder="Bonjour"
            [class.error]="wordForm.get('french_text')?.invalid && wordForm.get('french_text')?.touched"
          />
          <span class="error-message" *ngIf="wordForm.get('french_text')?.hasError('required') && wordForm.get('french_text')?.touched">
            Le texte fran√ßais est requis
          </span>
        </div>

        <div class="form-group">
          <label for="dutch_text">N√©erlandais</label>
          <input
            id="dutch_text"
            type="text"
            formControlName="dutch_text"
            placeholder="Hallo"
            [class.error]="wordForm.get('dutch_text')?.invalid && wordForm.get('dutch_text')?.touched"
          />
          <span class="error-message" *ngIf="wordForm.get('dutch_text')?.hasError('required') && wordForm.get('dutch_text')?.touched">
            Le texte n√©erlandais est requis
          </span>
        </div>

        <div class="form-group">
          <label for="lesson_id">Le√ßon</label>
          <select
            id="lesson_id"
            formControlName="lesson_id"
            [class.error]="wordForm.get('lesson_id')?.invalid && wordForm.get('lesson_id')?.touched"
          >
            <option value="">S√©lectionner une le√ßon</option>
            <option *ngFor="let lesson of lessons" [value]="lesson.id">
              {{ lesson.title }}
            </option>
          </select>
          <span class="error-message" *ngIf="wordForm.get('lesson_id')?.hasError('required') && wordForm.get('lesson_id')?.touched">
            La le√ßon est requise
          </span>
        </div>

        <div class="error-message" *ngIf="errorMessage">{{ errorMessage }}</div>
        <div class="success-message" *ngIf="successMessage">{{ successMessage }}</div>

        <div class="form-actions">
          <button type="submit" [disabled]="wordForm.invalid" class="btn-primary">
            {{ editingWord ? 'Mettre √† jour' : 'Ajouter' }}
          </button>
          <button type="button" class="btn-secondary" (click)="cancelEdit()" *ngIf="editingWord">
            Annuler
          </button>
        </div>
      </form>
    </div>

    <!-- Section d'import depuis texte -->
    <div class="form-section">
      <div class="import-header">
        <h2>Importer depuis texte</h2>
        <button 
          type="button" 
          class="btn-secondary" 
          (click)="toggleImportSection()"
          [class.active]="showImportSection">
          {{ showImportSection ? 'Masquer' : 'Afficher' }}
        </button>
      </div>

      <div class="import-section" [class.expanded]="showImportSection">
        <div class="import-form">
          <div class="form-group">
            <label for="lesson_import">Le√ßon</label>
            <select
              id="lesson_import"
              [(ngModel)]="selectedLessonForImport"
              [disabled]="isExtracting"
              class="form-control">
              <option value="">S√©lectionner une le√ßon</option>
              <option *ngFor="let lesson of lessons" [value]="lesson.id">
                {{ lesson.title }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="import_text">
              Texte n√©erlandais √† analyser
              <span class="char-counter" [class.warning]="getRemainingCharacters() < 100">
                ({{ getRemainingCharacters() }} caract√®res restants)
              </span>
            </label>
            <textarea
              id="import_text"
              [(ngModel)]="importText"
              [disabled]="isExtracting"
              [maxlength]="MAX_TEXT_LENGTH"
              placeholder="Collez ici votre texte en n√©erlandais (article, paragraphe, etc.)..."
              rows="6"
              class="form-control import-textarea"
              [class.error]="importError && !importText.trim()">
            </textarea>
            <div class="help-text">
              Maximum {{ MAX_TEXT_LENGTH }} caract√®res. L'IA extraira automatiquement les mots de vocabulaire importants et exclura les articles, pr√©positions, etc.
            </div>
          </div>

          <div class="error-message" *ngIf="importError">{{ importError }}</div>
          <div class="success-message" *ngIf="importSuccessMessage">{{ importSuccessMessage }}</div>

          <div class="form-actions">
            <button 
              type="button" 
              class="btn-primary" 
              (click)="extractWords()"
              [disabled]="isExtracting || !importText.trim() || !selectedLessonForImport">
              <span *ngIf="isExtracting">Extraction en cours...</span>
              <span *ngIf="!isExtracting">Extraire les mots</span>
            </button>
          </div>
        </div>

        <!-- Liste des mots extraits -->
        <div *ngIf="extractedWords.length > 0" class="extracted-words-section">
          <div class="extracted-words-header">
            <h3>Mots extraits ({{ extractedWords.length }})</h3>
            <div class="selection-actions">
              <button type="button" class="btn-link" (click)="selectAllWords()">Tout s√©lectionner</button>
              <span class="separator">|</span>
              <button type="button" class="btn-link" (click)="deselectAllWords()">Tout d√©s√©lectionner</button>
              <span class="selected-count">{{ getSelectedWordsCount() }} s√©lectionn√©(s)</span>
            </div>
          </div>

          <div class="extracted-words-list">
            <div *ngFor="let word of extractedWords; let i = index" class="extracted-word-item" [class.duplicate]="word.isDuplicate">
              <div class="word-checkbox">
                <input
                  type="checkbox"
                  [id]="'word-' + i"
                  [checked]="word.selected"
                  (change)="toggleWordSelection(i)"
                  [disabled]="isExtracting">
                <label [for]="'word-' + i"></label>
              </div>
              <div class="word-content">
                <div class="word-texts">
                  <span class="dutch-text">{{ word.dutch_text }}</span>
                  <span class="arrow">‚Üí</span>
                  <span class="french-text">{{ word.french_text }}</span>
                </div>
                <div class="word-metadata">
                  <span *ngIf="word.frequency && word.frequency > 1" class="frequency-badge">
                    Apparu {{ word.frequency }} fois
                  </span>
                  <span *ngIf="word.isDuplicate" class="duplicate-badge" [title]="'D√©j√† pr√©sent dans : ' + word.existingLessonTitle">
                    ‚ö†Ô∏è D√©j√† pr√©sent dans "{{ word.existingLessonTitle }}"
                  </span>
                </div>
              </div>
            </div>
          </div>

          <div class="import-actions">
            <button 
              type="button" 
              class="btn-primary" 
              (click)="importSelectedWords()"
              [disabled]="isExtracting || getSelectedWordsCount() === 0">
              <span *ngIf="isExtracting">Ajout en cours...</span>
              <span *ngIf="!isExtracting">Ajouter les {{ getSelectedWordsCount() }} mot(s) s√©lectionn√©(s)</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Liste des mots -->
    <div class="words-section">
      <h2>Tous les mots disponibles ({{ words.length }})</h2>
      <p class="info-text">Les modifications que vous apportez ici (masquer, √©diter) n'affectent que votre version personnelle. Vous voyez tous les mots de base, mais vous pouvez les personnaliser pour vos le√ßons.</p>
      
      <div *ngFor="let group of getWordsByLesson()" class="lesson-group">
        <div class="lesson-header" (click)="toggleLesson(group.lesson.id)">
          <h3 class="lesson-title">{{ group.lesson.title }} ({{ group.words.length }})</h3>
          <span class="toggle-icon" [class.expanded]="isLessonExpanded(group.lesson.id)">‚ñº</span>
        </div>
        
        <div class="lesson-content" [class.expanded]="isLessonExpanded(group.lesson.id)">
          <div class="words-table">
            <div class="table-header">
              <div class="col-french">Fran√ßais</div>
              <div class="col-dutch">N√©erlandais</div>
              <div class="col-actions">Actions</div>
            </div>
            
            <div *ngFor="let word of group.words" class="table-row">
              <div class="col-french" [title]="'ID: ' + word.id">
                {{ word.french_text }}
                <span class="modified-badge" *ngIf="isWordEdited(word.id)">(modifi√©)</span>
              </div>
              <div class="col-dutch" [title]="'ID: ' + word.id">{{ word.dutch_text }}</div>
              <div class="col-actions">
                <button class="btn-edit" (click)="editWord(word)">Modifier</button>
                <button class="btn-delete" (click)="deleteWord(word)">Masquer</button>
                <button class="btn-swap" (click)="swapWordLanguages(word)" title="Inverser les langues">üîÑ</button>
                <button *ngIf="isWordEdited(word.id)" class="btn-remove-edit" (click)="removeWordEdit(word)" title="Supprimer la modification personnelle">‚Ü©Ô∏è</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Mots masqu√©s -->
      <div *ngIf="hiddenWordIds.size > 0" class="hidden-words-section">
        <h3>Mots masqu√©s ({{ hiddenWordIds.size }})</h3>
        
        <div *ngFor="let group of getHiddenWordsByLesson()" class="lesson-group">
          <div class="lesson-header" (click)="toggleLesson('hidden-' + group.lesson.id)">
            <h4 class="lesson-title-small">{{ group.lesson.title }} ({{ group.words.length }})</h4>
            <span class="toggle-icon" [class.expanded]="isLessonExpanded('hidden-' + group.lesson.id)">‚ñº</span>
          </div>
          
          <div class="lesson-content" [class.expanded]="isLessonExpanded('hidden-' + group.lesson.id)">
            <div class="words-table">
              <div class="table-header">
                <div class="col-french">Fran√ßais</div>
                <div class="col-dutch">N√©erlandais</div>
                <div class="col-actions">Actions</div>
              </div>
              
              <div *ngFor="let word of group.words" class="table-row hidden-row">
                <div class="col-french" [title]="'ID: ' + word.id">{{ word.french_text }}</div>
                <div class="col-dutch" [title]="'ID: ' + word.id">{{ word.dutch_text }}</div>
                <div class="col-actions">
                  <button class="btn-restore" (click)="restoreWord(word)">R√©activer</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
